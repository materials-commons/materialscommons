<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        select {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .loading {
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .buttons {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .cancel-btn {
            background-color: #f44336;
        }

        .cancel-btn:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
<h3>Select Project and Experiment</h3>

<div class="form-group">
    <label for="project_select">Project:</label>
    <select id="project_select" onchange="onProjectChange()">
        <option value="">Select a project...</option>
        <? if (projects && projects.length > 0) { ?>
        <? for (var i = 0; i < projects.length; i++) { ?>
        <option value="<?= projects[i].id ?>"
        <?= projects[i].id == selectedProjectId ? 'selected' : '' ?>>
        <?= projects[i].name ?>
        </option>
        <? } ?>
        <? } ?>
    </select>
</div>

<div class="form-group">
    <label for="experiment_select">Experiment:</label>
    <select id="experiment_select" disabled>
        <option value="">Select a project first...</option>
    </select>
    <div id="experiments-loading" class="loading" style="display: none;">
        <span class="spinner"></span>Loading experiments...
    </div>
</div>

<div class="buttons">
    <button id="select-btn" onclick="selectProjectExperiment()" disabled>
        Select
    </button>
    <button class="cancel-btn" onclick="cancelSelection()">
        Cancel
    </button>
</div>

<script>
    function onProjectChange() {
        const projectSelect = document.getElementById('project_select');
        const experimentSelect = document.getElementById('experiment_select');
        const loadingDiv = document.getElementById('experiments-loading');
        const selectBtn = document.getElementById('select-btn');

        const selectedProjectId = projectSelect.value;

        // Reset experiments dropdown
        experimentSelect.innerHTML = '<option value="">Select an experiment...</option>';
        experimentSelect.disabled = true;
        selectBtn.disabled = true;

        if (selectedProjectId) {
            // Show loading indicator
            loadingDiv.style.display = 'block';

            // Fetch experiments for selected project
            google.script.run
                .withSuccessHandler(updateExperimentsList)
                .withFailureHandler(onExperimentsError)
                .getStudiesForProject(selectedProjectId);
        } else {
            experimentSelect.innerHTML = '<option value="">Select a project first...</option>';
            loadingDiv.style.display = 'none';
        }
    }

    function updateExperimentsList(experiments) {
        const experimentSelect = document.getElementById('experiment_select');
        const loadingDiv = document.getElementById('experiments-loading');

        loadingDiv.style.display = 'none';

        // Clear existing options
        experimentSelect.innerHTML = '<option value="">Select an experiment...</option>';

        if (experiments && experiments.length > 0) {
            experiments.forEach(function(experiment) {
                const option = document.createElement('option');
                option.value = experiment.id;
                option.textContent = experiment.name;
                experimentSelect.appendChild(option);
            });
            experimentSelect.disabled = false;
        } else {
            experimentSelect.innerHTML = '<option value="">No experiments found</option>';
        }
    }

    function onExperimentsError(error) {
        const experimentSelect = document.getElementById('experiment_select');
        const loadingDiv = document.getElementById('experiments-loading');

        loadingDiv.style.display = 'none';
        experimentSelect.innerHTML = '<option value="">Error loading experiments</option>';
        console.error('Failed to load experiments:', error);
    }

    // Enable select button when experiment is chosen
    document.getElementById('experiment_select').addEventListener('change', function() {
        const selectBtn = document.getElementById('select-btn');
        selectBtn.disabled = this.value === '';
    });

    function selectProjectExperiment() {
        const projectSelect = document.getElementById('project_select');
        const experimentSelect = document.getElementById('experiment_select');

        const selectedProject = {
            id: projectSelect.value,
            name: projectSelect.options[projectSelect.selectedIndex].text
        };

        const selectedExperiment = {
            id: experimentSelect.value,
            name: experimentSelect.options[experimentSelect.selectedIndex].text
        };

        // Call server-side function to save selection
        google.script.run
            .withSuccessHandler(onSelectionSuccess)
            .withFailureHandler(onSelectionError)
            .saveProjectStudySelection(selectedProject, selectedExperiment);
    }

    function onSelectionSuccess() {
        google.script.host.close();
    }

    function onSelectionError(error) {
        alert('Failed to save selection: ' + error.toString());
    }

    function cancelSelection() {
        google.script.host.close();
    }
</script>
</body>
</html>
