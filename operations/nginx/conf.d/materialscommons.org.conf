server {
   listen 80;
   server_name materialscommons.org;
   root /var/www/html;

   #location /.well-known/acme-challenge/ {
   #       root /var/www/html;
   #}

   #location / {
   #       return 301 https://$server_name$request_uri;
   #}


   ## redirect http to https ##
   return 301 https://$server_name$request_uri;
}

upstream ws {
   server localhost:1423;
}

server {
   listen 443 ssl;
   server_name materialscommons.org;
   root /var/www/html/materialscommons/public;
   client_max_body_size 850M;
   client_body_in_file_only clean;
   client_body_buffer_size 32k;
   client_body_timeout 300s;
   sendfile on;
   send_timeout 300s;

   ## SSL Config ##
   #ssl_certificate /etc/nginx/certs/materialscommons.org.cert;
   #ssl_certificate_key /etc/nginx/certs/materialscommons.org.key;

   ssl_certificate /etc/letsencrypt/live/materialscommons.org/fullchain.pem; # managed by Certbot
   ssl_certificate_key /etc/letsencrypt/live/materialscommons.org/privkey.pem; # managed by Certbot
   include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
   ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

   keepalive_timeout 70s;
   keepalive_requests 1000;
   ssl_session_cache shared:SSL:10m;
   #ssl_session_timeout 10m;

   add_header X-Frame-Options "SAMEORIGIN";
   add_header X-XSS-Protection "1; mode=block";
   add_header X-Content-Type-Options "nosniff";

   index index.html index.htm index.php;

   charset utf-8;

   if ($http_user_agent ~* "SemrushBot|Semrush|AhrefsBot|MJ12bot|YandexBot|YandexImages|MegaIndex.ru|BLEXbot|BLEXBot|ZoominfoBot|YaK|VelenPublicWebCrawler|SentiBot|Vagabondo|SEOkicks|SEOkicks-Robot|mtbot/1.1.0i|SeznamBot|DotBot|Cliqzbot|coccocbot|Scrap|SiteCheck-sitecrawl|MauiBot|Java|GumGum|Clickagy|AspiegelBot|Yandex|TkBot|CCBot|Qwantify|MBCrawler|serpstatbot|AwarioSmartBot|Semantici|ScholarBot|proximic|MojeekBot|GrapeshotCrawler|IAScrawler|linkdexbot|contxbot|PlurkBot|PaperLiBot|BomboraBot|Leikibot|weborama-fetcher|NTENTbot|Screaming Frog SEO Spider|admantx-usaspb|Eyeotabot|VoluumDSP-content-bot|SirdataBot|adbeat_bot|TTD-Content|admantx|Nimbostratus-Bot|Mail.RU_Bot|Quantcastboti|Onespot-ScraperBot|Taboolabot|Baidu|Jobboerse|VoilaBot|Sogou|Jyxobot|Exabot|ZGrab|Proximi|Sosospider|Accoona|aiHitBot|Genieo|BecomeBot|ConveraCrawler|NerdyBot|OutclicksBot|findlinks|JikeSpider|Gigabot|CatchBot|Huaweisymantecspider|Offline Explorer|SiteSnagger|TeleportPro|WebCopier|WebReaper|WebStripper|WebZIP|Xaldon_WebSpider|BackDoorBot|AITCSRoboti|Arachnophilia|BackRub|BlowFishi|perl|CherryPicker|CyberSpyder|EmailCollector|Foobot|GetURL|httplib|HTTrack|LinkScan|Openbot|Snooper|SuperBot|URLSpiderPro|MAZBot|EchoboxBot|SerendeputyBot|LivelapBot|linkfluence.com|TweetmemeBot|LinkisBot|CrowdTanglebot|PetalBot|petalsearch") { return 403; }

   location /docs {
       alias /var/www/html/docs/;
       index index.html;
   }

   location /mcdocs2 {
       alias /var/www/html/mcdocs2/;
       index index.html;
       expires 0;
       add_header Cache-Control "no-cache, no-store, must-revalidate";
       add_header Pragma "no-cache";
   }

   location /downloads {
       alias /var/www/html/downloads/;
   }

   location / {
      try_files $uri $uri/ /index.php?$query_string;
   }

   location /ws {
      proxy_pass http://ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
   }

   location = /favicon.ico { access_log off; log_not_found off; }
   location = /robots.txt  { access_log off; log_not_found off; }

   error_page 404 /index.php;

   location ~ \.php$ {
      fastcgi_pass unix:/run/php/php-fpm.sock;
      fastcgi_index index.php;
      fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
      include fastcgi_params;

      fastcgi_read_timeout 300;
      fastcgi_send_timeout 300;
      fastcgi_connect_timeout 300;

      fastcgi_buffer_size 64k;
      fastcgi_buffers 4 64k;
      fastcgi_busy_buffers_size 128k;
   }

   location /visus {
      rewrite /visus/(.*) /$1 break;
      proxy_pass http://localhost:8092;
      proxy_set_header Host $host;
   }

   location /uhcsapp/ {
      proxy_pass http://localhost:5006;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host:$server_port;
      proxy_buffering off;
   }

   location /uhcsdb/ {
      rewrite ^/uhcsdb/(.*) /$1 break;
      proxy_pass http://localhost:9000;
      proxy_set_header Host $host;
   }

   location /mod_visus {
      proxy_pass http://localhost:8092;
      proxy_set_header Host $host;
   }

   location /webdav/ {
      proxy_pass http://localhost:8555;
      proxy_set_header Host $host;
   }

   location /files {
      proxy_pass http://localhost:8558;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto "https";
      proxy_request_buffering off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Expect "";
      proxy_max_temp_file_size 0;
      proxy_busy_buffers_size 512k;
      proxy_buffers 16 64k;
      proxy_buffer_size 64k;
      #client_max_body_size 0;
      proxy_read_timeout 600s; 
      proxy_send_timeout 600s; 
      send_timeout 600s; 

      client_body_in_file_only off;
      client_body_timeout 600s;
      client_body_buffer_size 32k;

      gzip off;
      gunzip off;
      #proxy_gzip off;
      sendfile off;
      aio off;
      #limit_rate 0;
      #proxy_limit_rate 0;
      add_header X-TUS-Loc on ;

      #error_log /var/log/nginx/tus_error.log debug;
      #access_log /var/log/nginx/tus_access.log tus_timing;
   }

   location ~ /\.(?!well-known).* {
      deny all;
   }
}
